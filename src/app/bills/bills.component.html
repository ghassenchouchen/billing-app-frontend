<div class="page">
	<div class="page-header">
		<div>
			<h2 class="page-title">Factures</h2>
			<p class="page-subtitle">Suivez les factures, les statuts de paiement et les montants.</p>
		</div>
		<div class="page-actions">
			<span class="chip">{{listofbills.length || 0}} factures</span>
			<span class="chip secondary">Recalcul automatique activé</span>
		</div>
	</div>

	<div class="card section-card billing-run">
		<div class="card-header">
			<div>
				<h5 class="card-title mb-0">Filtrer les factures</h5>
				<p class="section-subtitle">Sélectionnez une période pour filtrer les factures par date.</p>
			</div>
			<div class="billing-run-actions">
				<input class="form-control" type="date" [(ngModel)]="filterStart" placeholder="Date début" />
				<input class="form-control" type="date" [(ngModel)]="filterEnd" placeholder="Date fin" />
				<button class="btn btn-action primary" type="button" (click)="filterBills()" [disabled]="!filterStart || !filterEnd">
					<span class="material-icons">filter_alt</span>
					Filtrer
				</button>
				<button class="btn btn-ghost" type="button" (click)="clearFilter()" *ngIf="filterStart || filterEnd">
					<span class="material-icons">clear</span>
					Réinitialiser
				</button>
			</div>
		</div>
	</div>

	<div class="card section-card data-table">
		<div class="card-header section-header">
			<div>
				<h5 class="card-title mb-1">Historique de facturation</h5>
				<p class="section-subtitle">Vue d’ensemble des factures et statuts de paiement.</p>
			</div>
			<!--<button class="btn btn-outline-primary btn-sm" type="button" (click)="exportBills()" [disabled]="!listofbills.length">
				Export
			</button>-->
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-striped table-hover">
					<thead>
						<tr>
							<th>ID Facture</th>
							<th>Client</th>
							<th>Montant</th>
							<th>Date</th>
							<th>Statut</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let bill of listofbills">
							  <td>{{bill.numeroFacture || bill.id}}</td>
							  <td>Client #{{bill.clientId}}</td>
							<td>{{bill.montantTTC | number:'1.2-2'}}</td>
							<td>{{bill.dateFacture || '—'}}</td>
							<td>
								<span class="badge-soft success" *ngIf="bill.statut === 'PAID'">Payée</span>
								<span class="badge-soft info" *ngIf="bill.statut === 'SENT'">Envoyée</span>
								<span class="badge-soft warning" *ngIf="bill.statut === 'DRAFT'">Brouillon</span>
								<span class="badge-soft warning" *ngIf="bill.statut === 'PENDING'">En attente</span>
								<span class="badge-soft neutral" *ngIf="bill.statut === 'OVERDUE'">En retard</span>
								<span class="badge-soft neutral" *ngIf="bill.statut === 'CANCELLED'">Annulée</span>
							</td>
							<td class="actions-cell">
								<button class="btn btn-ghost" type="button" (click)="detail(bill.id)">
									<span class="material-icons">visibility</span>
									Voir les détails
								</button>
								
								<button class="btn btn-action" type="button" (click)="Calculate(bill.id)" [disabled]="calculatingId === bill.id">
									<span class="material-icons">calculate</span>
									{{ calculatingId === bill.id ? 'Recalcul…' : 'Recalculer' }}
								</button>
								<button class="btn btn-ghost" type="button" (click)="exportBill(bill)">
									<span class="material-icons">download</span>
									Export
								</button>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<div class="card section-card" *ngIf="billdetails">
		<div class="card-header">
			<h5 class="card-title mb-0">Détails de la facture</h5>
		</div>
		<div class="card-body bill-details">
			<div>
				<strong>Facture:</strong> #{{billdetails.numeroFacture || billdetails.id}}
			</div>
			<div>
				<strong>Client:</strong> Client #{{billdetails.clientId}}
			</div>
			<div>
				<strong>Période:</strong>
				{{billdetails.periodeDebut || '—'}} au {{billdetails.periodeFin || '—'}}
			</div>
			<div>
				<strong>Montant HT:</strong> {{billdetails.montantHT | number:'1.2-2'}}
			</div>
			<div>
				<strong>TVA:</strong> {{billdetails.montantTVA | number:'1.2-2'}}
			</div>
			<div>
				<strong>Montant TTC:</strong> {{billdetails.montantTTC | number:'1.2-2'}}
			</div>
			<div>
				<strong>Statut:</strong> {{billdetails.statut}}
			</div>
			<div>
				<strong>Date facture:</strong> {{billdetails.dateFacture || '—'}}
			</div>
			<div>
				<strong>Date échéance:</strong> {{billdetails.dateEcheance || '—'}}
			</div>
			<div class="bill-lines" *ngIf="billLines.length">
				<h6 class="bill-lines-title">Lignes de facture</h6>
				<div class="table-responsive">
					<table class="table table-sm">
						<thead>
							<tr>
								<th>Service</th>
								<th>Quantité</th>
								<th>Prix unitaire</th>
								<th>Montant</th>
							</tr>
						</thead>
						<tbody>
							<tr *ngFor="let line of billLines">
								<td>{{line.description || '—'}}</td>
								<td>{{line.quantite}}</td>
								<td>{{line.prixUnitaire | number:'1.2-2'}}</td>
								<td>{{line.montant | number:'1.2-2'}}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
