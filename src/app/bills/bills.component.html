<div class="page">
	<div class="page-header">
		<div>
			<h2 class="page-title">Factures</h2>
			<p class="page-subtitle">Suivez les factures, les statuts de paiement et les montants.</p>
		</div>
		<div class="page-actions">
			<span class="chip">{{listofbills.length || 0}} factures</span>
			<span class="chip secondary">Recalcul automatique activé</span>
		</div>
	</div>

	<div class="card section-card billing-run">
		<div class="card-header">
			<div>
				<h5 class="card-title mb-0">Filtrer les factures</h5>
				<p class="section-subtitle">Sélectionnez une période pour filtrer les factures par date.</p>
			</div>
			<div class="billing-run-actions">
				<input class="form-control" type="date" [(ngModel)]="filterStart" placeholder="Date début" />
				<input class="form-control" type="date" [(ngModel)]="filterEnd" placeholder="Date fin" />
				<button class="btn btn-action primary" type="button" (click)="filterBills()" [disabled]="!filterStart || !filterEnd">
					<span class="material-icons">filter_alt</span>
					Filtrer
				</button>
				<button class="btn btn-ghost" type="button" (click)="clearFilter()" *ngIf="filterStart || filterEnd">
					<span class="material-icons">clear</span>
					Réinitialiser
				</button>
			</div>
		</div>
	</div>

	<div class="card section-card data-table">
		<div class="card-header section-header">
			<div>
				<h5 class="card-title mb-1">Historique de facturation</h5>
				<p class="section-subtitle">Vue d’ensemble des factures et statuts de paiement.</p>
			</div>
			<!--<button class="btn btn-outline-primary btn-sm" type="button" (click)="exportBills()" [disabled]="!listofbills.length">
				Export
			</button>-->
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-striped table-hover">
					<thead>
						<tr>
							<th>ID Facture</th>
							<th>Client</th>
							<th>Montant</th>
							<th>Date</th>
							<th>Statut</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let bill of listofbills">
							  <td>{{bill.facture_id}}</td>
							  <td>{{bill.client_name || 'Client #' + bill.client_id}}</td>
							<td>{{bill.somme_tot | number:'1.2-2'}}</td>
							<td>{{bill.date || '—'}}</td>
							<td>
								<span class="badge-soft success" *ngIf="bill.status === 'paid'">Payée</span>
								<span class="badge-soft info" *ngIf="bill.status === 'partially_paid'">Partiellement payée</span>
								<span class="badge-soft warning" *ngIf="bill.status !== 'paid' && bill.status !== 'partially_paid'">En attente</span>
							</td>
							<td class="actions-cell">
								<button class="btn btn-ghost" type="button" (click)="detail(bill.facture_id)">
									<span class="material-icons">visibility</span>
									Voir les détails
								</button>
								
								<button class="btn btn-action" type="button" (click)="Calculate(bill.facture_id)" [disabled]="calculatingId === bill.facture_id">
									<span class="material-icons">calculate</span>
									{{ calculatingId === bill.facture_id ? 'Recalcul…' : 'Recalculer' }}
								</button>
								<button class="btn btn-ghost" type="button" (click)="exportBill(bill)">
									<span class="material-icons">download</span>
									Export
								</button>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<div class="card section-card" *ngIf="billdetails">
		<div class="card-header">
			<h5 class="card-title mb-0">Détails de la facture</h5>
		</div>
		<div class="card-body bill-details">
			<div>
				<strong>Facture:</strong> #{{billdetails.facture_id}}
			</div>
			<div>
				<strong>Client:</strong> {{billdetails.client_name || 'Client #' + billdetails.client_id}}
			</div>
			<div>
				<strong>Consommation:</strong>
				{{billdetails.consom_appel}} appel / {{billdetails.consom_sms}} SMS / {{billdetails.consom_internet}} internet
			</div>
			<div *ngIf="billdetails.total_paid !== undefined">
				<strong>Total payé:</strong> {{billdetails.total_paid | number:'1.2-2'}}
			</div>
			<div *ngIf="billdetails.balance_due !== undefined">
				<strong>Reste à payer:</strong> {{billdetails.balance_due | number:'1.2-2'}}
			</div>
			<div *ngIf="billdetails.status">
				<strong>Statut:</strong> {{billdetails.status}}
			</div>
			<div>
				<strong>Montant:</strong> {{billdetails.somme_tot | number:'1.2-2'}}
			</div>
			<div class="bill-lines" *ngIf="billLines.length">
				<h6 class="bill-lines-title">Lignes de facture</h6>
				<div class="table-responsive">
					<table class="table table-sm">
						<thead>
							<tr>
								<th>Service</th>
								<th>Quantité</th>
								<th>Prix unitaire</th>
								<th>Montant</th>
							</tr>
						</thead>
						<tbody>
							<tr *ngFor="let line of billLines">
								<td>{{line.service_name || line.service_id || '—'}}</td>
								<td>{{line.quantity}}</td>
								<td>{{line.unit_price | number:'1.2-2'}}</td>
								<td>{{line.amount | number:'1.2-2'}}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
